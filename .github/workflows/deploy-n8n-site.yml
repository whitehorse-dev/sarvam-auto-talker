name: Deploy n8n.howtheyearned.com

on:
  push:
    branches:
      - main
    paths:
      - "web/**"
      - "server/**"
      - ".github/workflows/deploy-n8n-site.yml"
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      SSH_HOST: ${{ secrets.N8N_SARVAM_SSH_HOST }}
      SSH_USER: ${{ secrets.N8N_SARVAM_SSH_USER }}
      APP_DIR: ${{ secrets.N8N_SARVAM_APP_DIR }}
      PM2_APP_NAME: ${{ secrets.N8N_SARVAM_PM2_APP_NAME }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate site files
        run: |
          test -f web/index.html
          test -f server/package.json
          test -f server/src/index.js

      - name: Setup SSH key
        run: |
          test -n "$SSH_HOST"
          test -n "$SSH_USER"
          test -n "$APP_DIR"
          test -n "$PM2_APP_NAME"
          test -n "${{ secrets.N8N_SARVAM_KNOWN_HOSTS }}"
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          printf '%s' "${{ secrets.N8N_SARVAM_SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          printf '%s\n' "${{ secrets.N8N_SARVAM_KNOWN_HOSTS }}" > ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts
          cat > ~/.ssh/config << EOF
          Host deploy-host
            HostName $SSH_HOST
            User $SSH_USER
            IdentityFile ~/.ssh/id_ed25519
            StrictHostKeyChecking yes
          EOF
          chmod 600 ~/.ssh/config

      - name: Sync web files
        run: |
          ssh deploy-host "mkdir -p $APP_DIR/web $APP_DIR/server"
          rsync -az --delete \
            --exclude '.git' \
            web/ "deploy-host:$APP_DIR/web/"

      - name: Sync server files
        run: |
          rsync -az --delete \
            --exclude '.git' \
            --exclude 'node_modules' \
            --filter='P .env' \
            server/ "deploy-host:$APP_DIR/server/"

      - name: Write server env (optional)
        run: |
          if [ -n "${{ secrets.N8N_SARVAM_SERVER_ENV }}" ]; then
            printf '%s' "${{ secrets.N8N_SARVAM_SERVER_ENV }}" > server_env.tmp
            scp server_env.tmp "deploy-host:$APP_DIR/server/.env"
            rm -f server_env.tmp
            ssh deploy-host "chmod 600 $APP_DIR/server/.env"
          else
            echo "N8N_SARVAM_SERVER_ENV not set; keeping existing server/.env on host"
          fi

      - name: Install server dependencies
        run: |
          ssh deploy-host "cd $APP_DIR/server && npm ci --omit=dev"

      - name: Restart backend
        run: |
          ssh deploy-host "\
            pm2 delete $PM2_APP_NAME >/dev/null 2>&1 || true; \
            cd $APP_DIR/server && PORT=3004 NODE_ENV=production pm2 start npm --name $PM2_APP_NAME -- start; \
            pm2 save\
          "

      - name: Verify health
        run: |
          ssh deploy-host "curl -fsS http://127.0.0.1:3004/health"
